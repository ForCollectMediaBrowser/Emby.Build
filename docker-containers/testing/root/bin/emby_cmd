#!/usr/bin/with-contenv bash
# vim:set ft=sh sw=2 sts=2 st=2 et:
set -e

USER_UID=${USER_UID:-1000}
USER_GID=${USER_GID:-1000}

EMBYSERVER_USER=${EMBYSERVER_USER:-emby}
EMBYSERVER_REPO=${EMBYSERVER_REPO:-emby}

install_embyserver() {
  echo "Installing Emby Server..."
  install -m 0755 /var/cache/scripts/emby-server /target/
  if [ "${EMBYSERVER_USER}" != "emby" ] && [ -n "${EMBYSERVER_USER}" ]; then
    echo "Updating user to ${EMBYSERVER_USER}..."
    sed -i -e s%"EMBYSERVER_USER:-emby"%"EMBYSERVER_USER:-${EMBYSERVER_USER}"%1 /target/emby-server
  fi

  if [ -n $EMBYSERVER_CONFIG ]; then
    echo "Updating data config directory."
    sed -i -e s%"\(EMBYSERVER_CONFIG=\).*"%"\1${EMBYSERVER_CONFIG}"%1 /target/emby-server
  fi

  exec s6-svscanctl -t /var/run/s6/services
}

install_embyserver_service() {
  echo "Installing Emby Service..."
  install -m 0755 /var/cache/systemd/emby-server.service /target/
  echo "Please run: sudo systemctl daemon-reload"
  echo "To start run: sudo systemctl start emby-server"
  exec s6-svscanctl -t /var/run/s6/services
}

uninstall_embyserver() {
  echo "Uninstalling Emby Server..."
  rm -rf /target/emby-server
  exec s6-svscanctl -t /var/run/s6/services
}

uninstall_service() {
  echo "Uninstalling Emby Service..."
  rm -rf /target/emby-server.service
  exec s6-svscanctl -t /var/run/s6/services
}

case "$1" in
  install)
    install_embyserver
    ;;
  install_service)
    install_embyserver_service
    ;;
  uninstall)
    uninstall_embyserver
    ;;
  uninstall_service)
    uninstall_embyserver
    ;;
esac
