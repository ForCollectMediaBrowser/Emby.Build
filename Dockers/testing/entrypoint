#!/bin/bash
set -e

USER_UID=${USER_UID:-1000}
USER_GID=${USER_GID:-1000}

EMBYSERVER_USER=${EMBYSERVER_USER:-emby}
EMBYSERVER_REPO=${EMBYSERVER_REPO:-emby}

install_embyserver() {
  echo "Installing Emby Server..."
  install -m 0755 /var/cache/emby-server/emby-server /bin-target/
  echo "Installing Emby Service..."
  install -m 0755 /var/cache/emby-server/emby-server.service /service-target/
  if [ "${EMBYSERVER_USER}" != "emby" ] && [ -n "${EMBYSERVER_USER}" ]; then
    echo "Updating user to ${EMBYSERVER_USER}..."
    sed -i -e s%"EMBYSERVER_USER:-emby"%"EMBYSERVER_USER:-${EMBYSERVER_USER}"%1 /bin-target/emby-server
  fi
}

uninstall_embyserver() {
  echo "Uninstalling Emby Server..."
  rm -rf /bin-target/emby-server
  echo "Uninstalling Emby Service..."
  rm -rf /service-target/emby-server.service
}

create_user() {
  # ensure home directory is owned by browser
  # and that profile files exist
  if [[ -d /home/${EMBYSERVER_USER} ]]; then
    chown ${USER_UID}:${USER_GID} /home/${EMBYSERVER_USER}
    # copy user files from /etc/skel
    cp /etc/skel/.bashrc /home/${EMBYSERVER_USER}
    cp /etc/skel/.bash_logout /home/${EMBYSERVER_USER}
    cp /etc/skel/.profile /home/${EMBYSERVER_USER}
    chown ${USER_UID}:${USER_GID} \
      /home/${EMBYSERVER_USER}/.bashrc \
      /home/${EMBYSERVER_USER}/.profile \
      /home/${EMBYSERVER_USER}/.bash_logout
  fi
  # create group with USER_GID
  if ! getent group ${EMBYSERVER_USER} >/dev/null; then
    groupadd -f -g ${USER_GID} ${EMBYSERVER_USER} 2> /dev/null
  fi

  # create user with USER_UID
  if ! getent passwd ${EMBYSERVER_USER} >/dev/null; then
    adduser --disabled-login --uid ${USER_UID} --gid ${USER_GID} \
      --gecos 'Emby Server' ${EMBYSERVER_USER}
  fi
}

launch_embyserver() {
  cd /home/${EMBYSERVER_USER}
  exec sudo -u ${EMBYSERVER_USER} -H $@ ${extra_opts}
}

case "$1" in
  install)
    install_embyserver
    ;;
  uninstall)
    uninstall_embyserver
    ;;
  embyserver)
    create_user
    launch_embyserver $@
  bash)
    create_user
    exec bash
    ;;
  *)
    exec $@
    ;;
esac
