#!/bin/sh
# vim:set ft=sh sw=2 sts=2 st=2 et:
# Author: HurricaneHernandez <carlos@techbyte.ca>
# Modified for CentOS/Fedora by: FC7 <casasfernando@outlook.com>

DESC=EmbyServer
PATH=/sbin:/usr/sbin:/bin:/usr/bin
NAME=emby-server
CONF_FILE=/etc/${NAME}.conf
DEFAULT_FILE=/etc/default/${NAME}
SCRIPTNAME=/usr/bin/emby-server
LOG_FILE=/var/log/${NAME}.log

# Source Emby server default configuration
. $DEFAULT_FILE

# Source Emby server user configuration overrides
if [ -f $CONF_FILE ]; then
  . $CONF_FILE
else
  echo "${CONF_FILE} not found using default settings.";
fi

# Run as username
USER=$EMBY_USER
GROUP=$EMBY_GROUP

# Ensure user has restart permission
if [ "$USER" != "emby " ]; then
  [[ $(sed -n -e '/^emby/p' /etc/group | grep -c "$USER") ==  0 ]] && \
    usermod -a -G emby $USER > /dev/null 2>&1
fi

# Data directory where Emby database, cache and logs are stored
PROGRAMDATA=$EMBY_DATA
PROGRAMDATA_OPT="-programdata $PROGRAMDATA"

# Path to store PID file
PIDFILE=$EMBY_PIDFILE

# Full path of Emby binary
EMBY_EXEC=$EMBY_BIN

# Path of emby program files
EMBY_PATH=$EMBY_DIR

# path to mono bin
MONO_EXEC=$MONO_BIN

# Mono environment variables
MAGICK_LIBRARY_PATH=$(find /usr/lib/emby-server/ -maxdepth 1 -mindepth 1 -type d| grep -v bin)
MONO_EXEC_ENV="$MONO_ENV LD_LIBRARY_PATH=${MAGICK_LIBRARY_PATH}${LD_LIBRARY_PATH:+:}$LD_LIBRARY_PATH"

# Mono options
MONO_EXEC_OPTS=$MONO_OPTS

# ffmpeg
FFMPEG_BIN=$(command -v ffmpeg)
[ -n "$FFMPEG_BIN" ] && FFMPEG_OPTS="-ffmpeg $FFMPEG_BIN"

# ffprobe
FFPROBE_BIN=$(command -v ffprobe)
[ -n "$FFPROBE_BIN" ] && FFPROBE_OPTS="-ffprobe $FFPROBE_BIN"

# restart function
RESTART_OPTS="-restartpath ${EMBY_PATH}/restart.sh"

# Emby options
EMBY_OPTS="$PROGRAMDATA_OPT $FFMPEG_OPTS $FFPROBE_OPTS $RESTART_OPTS $EMBY_ADD_OPTS"

PID_PATH=`dirname $PIDFILE`

# Exit if the mono-sgen not installed
[ -x $MONO_EXEC ] || exit 0

# Create programdata  directory if not exist and ensure the emby user can write to it
if [ ! -d $PROGRAMDATA ]; then
  mkdir -p $PROGRAMDATA
fi

# Set right permission for directories
DATA_CURRENT_USER=`ls -lad $PROGRAMDATA | awk '{print $3}'`

if [ "$DATA_CURRENT_USER" != "$USER" ]; then
  chown -R $USER.$GROUP $PROGRAMDATA
fi

case "$1" in
  start)
    echo $$ > $PIDFILE
    exec su -s /bin/sh -c 'exec "$0" "$@"' $USER -- \
      env $MONO_EXEC_ENV $MONO_EXEC $MONO_EXEC_OPTS $EMBY_EXEC $EMBY_OPTS > $LOG_FILE 2>&1
    ;;
  clear)
    [ -e $PIDFILE ] && rm -rf $PIDFILE
    ;;
  *)
    echo "Usage: $SCRIPTNAME {start|clear}" >&2
    exit 3
    ;;
esac
